name: Update Movies

on:
  schedule:
    - cron: '0 */8 * * *' # Run every 8 hours
  workflow_dispatch: # Allow manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # ---------------------------------------------------------
      # STEP 1: Scrape Movies (DIRECT CONNECTION)
      # ---------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Install Python Deps
        run: pip install -r requirements.txt
      
      - name: Run Scraper
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python scraper.py --once

      # ---------------------------------------------------------
      # STEP 2: Publish (DIRECT CONNECTION - NO VPN)
      # ---------------------------------------------------------
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      
      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            publisher/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('publisher/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Publish to Iroh Network
        working-directory: ./publisher
        env:
          PUBLISHER_SECRET: ${{ secrets.PUBLISHER_SECRET }}
        run: |
          mkdir -p publisher_data
          if [ -n "$PUBLISHER_SECRET" ]; then
             echo "Importing Secret Key..."
             python3 -c "
             import os
             import binascii
             import sys

             try:
                 path = 'publisher_data/secret_key'
                 secret = os.environ['PUBLISHER_SECRET']
                 if not secret:
                     print('Error: PUBLISHER_SECRET env var is empty')
                     sys.exit(1)
                     
                 # Clean the secret
                 hexval = secret.strip().replace(' ', '').replace('\\n', '').replace('\\r', '')
                 print(f'Secret length: {len(hexval)}')
                 
                 if len(hexval) % 2 != 0:
                     print('Error: Secret length is odd, cannot be hex string')
                     sys.exit(1)
                     
                 try:
                     data = binascii.unhexlify(hexval)
                     with open(path, 'wb') as f:
                         f.write(data)
                     print('Secret key imported successfully')
                 except binascii.Error as e:
                     print(f'Error decoding hex: {e}')
                     sys.exit(1)
             except Exception as e:
                 print(f'Unexpected error: {e}')
                 sys.exit(1)
             "
          else
             echo "WARNING: No PUBLISHER_SECRET found."
          fi
          
          # DIRECT CONNECTION (No VPN)
          cargo run --release -- ingest ../latest_movies.json
