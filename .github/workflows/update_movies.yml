name: Update Movies

on:
  schedule:
    - cron: '0 */8 * * *' # Run every 8 hours
  workflow_dispatch: # Allow manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # ---------------------------------------------------------
      # STEP 1: Scrape Movies (DIRECT CONNECTION)
      # ---------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Install Python Deps
        run: pip install -r requirements.txt
      
      - name: Run Scraper
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python scraper.py --once

      # ---------------------------------------------------------
      # STEP 2: Publish (DIRECT CONNECTION - NO VPN)
      # ---------------------------------------------------------
      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      
      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            publisher/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('publisher/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Cache Publisher Data
        uses: actions/cache@v3
        with:
          path: publisher/publisher_data
          key: publisher-data-${{ github.run_id }}
          restore-keys: |
            publisher-data-
      
      - name: Build Publisher
        working-directory: ./publisher
        run: cargo build --release

      - name: Publish to Iroh Network (2m limit)
        working-directory: ./publisher
        env:
          PUBLISHER_SECRET: ${{ secrets.PUBLISHER_SECRET }}
          N0DES_API_SECRET: ${{ secrets.N0DES_API_SECRET }}
        run: |
          mkdir -p publisher_data
          if [ -n "$PUBLISHER_SECRET" ]; then
             echo "Importing Secret Key..."
             echo "Creating secret import script..."
             echo "aW1wb3J0IG9zCmltcG9ydCBiaW5hc2NpaQppbXBvcnQgc3lzCgp0cnk6CiAgICBwYXRoID0gJ3B1Ymxpc2hlcl9kYXRhL3NlY3JldF9rZXknCiAgICBzZWNyZXQgPSBvcy5lbnZpcm9uLmdldCgnUFVCTElTSEVSX1NFQ1JFVCcsICcnKQogICAgaWYgbm90IHNlY3JldDoKICAgICAgICBwcmludCgnRXJyb3I6IFBVQkxJU0hFUl9TRUNSRVQgZW52IHZhciBpcyBlbXB0eScpCiAgICAgICAgc3lzLmV4aXQoMSkKICAgIAogICAgIyBDbGVhbiB0aGUgc2VjcmV0CiAgICBoZXh2YWwgPSBzZWNyZXQuc3RyaXAoKS5yZXBsYWNlKCcgJywgJycpLnJlcGxhY2UoJ1xuJywgJycpLnJlcGxhY2UoJ1xyJywgJycpCiAgICBwcmludChmJ1NlY3JldCBsZW5ndGg6IHtsZW4oaGV4dmFsKX0nKQogICAgCiAgICBpZiBsZW4oaGV4dmFsKSAlIDIgIT0gMDoKICAgICAgICBwcmludCgnRXJyb3I6IFNlY3JldCBsZW5ndGggaXMgb2RkLCBjYW5ub3QgYmUgaGV4IHN0cmluZycpCiAgICAgICAgc3lzLmV4aXQoMSkKICAgICAgICAKICAgIHRyeToKICAgICAgICBkYXRhID0gYmluYXNjaWkudW5oZXhsaWZ5KGhleHZhbCkKICAgICAgICB3aXRoIG9wZW4ocGF0aCwgJ3diJykgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShkYXRhKQogICAgICAgIHByaW50KCdTZWNyZXQga2V5IGltcG9ydGVkIHN1Y2Nlc3NmdWxseScpCiAgICBleGNlcHQgYmluYXNjaWkudW5oZXhsaWZ5KGhleHZhbCkKICAgICAgICBwcmludChmJ0Vycm9yIGRlY29kaW5nIGhleDoge2V9JykKICAgICAgICBzeXMuZXhpdCgxKQpleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICBwcmludChmJ1VuZXhwZWN0ZWQgZXJyb3I6IHtlfScpCiAgICBzeXMuZXhpdCgxKQo=" | base64 -d > import_secret.py
             python3 import_secret.py
          else
             echo "WARNING: No PUBLISHER_SECRET found."
          fi
          
          # Run binary with 2 minute timeout. 
          # Exit code 124 means timeout occurred (success for us).
          timeout 2m ./target/release/kinoteka-publisher ingest ../latest_movies.json || [ $? -eq 124 ]
